name: iris-mlops-ci

on:
  push:
  pull_request:

jobs:
  build-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Start stack (MinIO + MLflow + App)
        run: docker compose up -d --build

      - name: Wait for services
        run: |
          timeout 90 bash -c 'until curl -fsS http://localhost:5000/health || curl -fsS http://localhost:5000; do sleep 3; done'
          timeout 90 bash -c 'until curl -fsS http://localhost:9001; do sleep 3; done'

      - name: Create MinIO bucket
        run: |
          docker exec minio mc alias set local http://localhost:9000 ${MINIO_ROOT_USER} ${MINIO_ROOT_PASSWORD} || true
          docker exec minio mc mb -p local/${MLFLOW_S3_BUCKET} || true
        env:
          MINIO_ROOT_USER: ${{ secrets.MINIO_ROOT_USER }}
          MINIO_ROOT_PASSWORD: ${{ secrets.MINIO_ROOT_PASSWORD }}
          MLFLOW_S3_BUCKET: ${{ vars.MLFLOW_S3_BUCKET || 'mlflow' }}

      - name: Run unit tests
        run: pytest -v
